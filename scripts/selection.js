/* eslint-disable no-case-declarations */
/* eslint-disable no-control-regex */

// Global Constants
const mycroftUrl = 'https://mycroftproject.com/installos.php/';
const bingUrl = 'https://www.bing.com/visualsearch';
const googleReverseImageSearchUrl = 'https://www.google.com/searchbyimage?sbisrc=1&safe=off&image_url=';
const googleLensUrl = 'https://lens.google.com/uploadbyurl?url=';
const tineyeUrl = 'https://www.tineye.com';
const chatGPTUrl = 'https://chatgpt.com';
const googleAIStudioUrl = 'https://aistudio.google.com/app/prompts/new_chat';
const grokUrl = 'https://grok.com';
const perplexityAIUrl = 'https://www.perplexity.ai';
const poeUrl = 'https://poe.com';
const claudeUrl = 'https://claude.ai';
const youUrl = 'https://you.com';
const andiUrl = 'https://andisearch.com';
const aiUrls = [chatGPTUrl, googleAIStudioUrl, grokUrl, perplexityAIUrl, poeUrl, claudeUrl, youUrl, andiUrl];

const base64MultiSearchIcon = 'iVBORw0KGgoAAAANSUhEUgAAAoAAAAKACAYAAAAMzckjAAAgAElEQVR4nOzdd5hV1303+u9v7dOm06sQIAmBhECCAXVLI3eQQJLtcRFFspMo9n1jp9hO3uS+N5cnea/fFD1JHMcpiquaC4lsg4qLbKNuIUYF1EAgkOh1YNqpe//uHwMykgAx++xz1i7fz/PMIyx5n/kyc87Z37PW2msDREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREYSa2AxARhUlHR0cKmJIqju6XUmG4lIt5cdsKMqzYIgBQKRel0lySVF9G+5pLXivg9gDu6P37vTVr1rgA1PJfgYjoXbEAElGYyRWLP9NcKRfbShm0wnXajLgtqmgyYppV0QTjNaknzcagSRVNAJoEklN4OQhyqpITIAdBFio5wMsBkgGQBpA6+nX8n4PgHv0qAVICtDT456NfghIURQUKAAYADBggP/hnGVD18oAZAHQAgh5V7TUwvSrS46nXm1Kv1zPac6Qyqnfzg18rBpSZiBKEBZCIau6cBZ/PDs/sH4OyGVkxMtIYM0JUR3jASIGMEOgITzFSDIZDMQxAK4C2o/80dtOHXgFAN6CHAOkWoFsF3fDQrUC3MTjoebofYvaL8fabcnp/08C2A2vWrKnYDk5E9rAAEpEvHR235AZa3PFqdLx6GK/QCRCMEZUxCoxRxRgRjAEwBoNFjsJDARwGcADAPgh2Q2W3QvdAsRsGu9XDbjctu9dfePYBrFjhWc5LRAFjASSid5h17U3D005qksCbBE8miegkFZyhnk4QwXhAJgAYbjsn1UUFwC4A21Wx3RhsV9XtgGxXz9teyTjb1//ozn22QxLR0LAAEiXQJYs/NbasZqqBTPWAqQJMBXAmgElHv5rtJqSIGQB0K2C2AtgqwFaFbvUUWzOubn3qwbt7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';

const base64BackIcon =
    'iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC+ElEQVR4nO1ZTWsUQRAd/DjoTaMXP36FGBIQFrqXECGHxOp2k3jyEjyIR6NByEWNIHgIJhr8AcKY6o1rVATx4ywqagzEg6LmoMluPEmyRhmp3Rg364ad6amZMbAPCgYGpt7rru6ufuM4DTTQQGhoV2+WRrcKhAGBCiXCW4mwIA38KEXpWU2V3hl1No1dLYODg5ucpNGWzeyXRl2SBmalUV7A+CwQhlLYtS924u2u3i0QxoSBogXxNSEMFAXCqDSdTbGQT4/rXmGgEJb4P0JQ5eW4zkRG/MBY31Zp4AY3cVkdqK6lHqe2sJLvyHVsl6juRU7erJbVJOXkG/kYycsKESwzEUvZmPXWBYyGI4/qWFLk5UqkDRy1HPnOJokwn7QAgSqfyvXsCiyA9vmkycu/cTUQeTodOQ4pxllYEq7eG6B8qD0Il/Ty8xFmEXDRF3lqsqhPsU3Uls14N2eyHoF3JmCWmkYfo69bbZMcmTzuvZx7UyLPL0B5wujmugKoJbb5+IlHp70v3+dWyUchIG30GR8zACboh4eeDXtLP4tryEchQBq45UOAmrKp91pgLyGE1/VLyGerXF3vtTC98C5QyHp5Eeb9CCja1DsHZN0ZUEssAnLvH7CT5xTgq4SuvLjuLf9a9jghOUooyCI+9fScV1j8ti6hk08GAoVkWcRl68P3zpC53+dNF2bsRtQEDjeSg6x9ose7++Fh5AIEQn9dAWQ62SaoXhfsM4BdB301cwLhk22SynXBOvoGPvp288gxC5Psz7pgnoELTpwXmsO3e5K70BDKdh9zDduXz7ATFG2u3ikMzCVOHlXe2jcVqLqTF6CVEwbkVW6o0qn98yL4JYehdO6wmbxktJJXGZsAVLkWV29zOEGjEcfOJAwMs9vrlSCvMgrLURj1NfSCDbLFkt1HB0x48rBIo35osneHEzfodCTHzKZ3ot5GIpxPT3TvcZJGqQE0upl8G7I+6OJBN7vSD7xy0C3v1cq7fuoq/4vfrA004Gx8/AaA9k9iqAR7zQAAAABJRU5ErkJggg==';

const base64ContextSearchIcon =
    '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';

const notifySearchEngineNotFound = browser.i18n.getMessage('notifySearchEngineNotFound');
const ICON32 = '32px'; // icon width is 32px

// Global variables
let logToConsole = false; // Debug (default)
let os = null;
let meta = ''; // meta key: cmd for macOS, win for Windows, super for Linux
let tabUrl = '';
let domain = '';
let pn = '';
let keysPressed = {};
let textSelection = '';
let navEntered = false;
let xPos;
let yPos;
let options;
let searchEngines;

// Track selection state
let selectionActive = false;

// Current state
console.log(`Document ready state: ${document.readyState}`);

if (document.readyState === "complete") {
    (async () => {
        console.log('Document ready state: complete');
        await init();
    })();
} else {
    document.onreadystatechange = async () => {
        if (document.readyState === "complete") {
            console.log('Document ready state: complete');
            await init();
        }
    };
}

// Mouseover event listener
document.addEventListener('mouseover', handleMouseOver);

// Right-click event listener
document.addEventListener('contextmenu', handleRightClickWithoutGrid);

// Mouse down event listener
document.addEventListener('mousedown', startSelection);

// Mouse up event listener
document.addEventListener('mouseup', handleAltClickWithGrid);

// Key down event listener
document.addEventListener('keydown', (event) => {
    const key = event.key;
    if (event.target.nodeName === 'INPUT' || !isKeyAllowed(event)) return;
    keysPressed[key] = event.code;
    if (logToConsole) console.log(keysPressed);
});

// Key up event listener
document.addEventListener('keyup', handleKeyUp);

/// Handle Incoming Messages
// Listen for messages from the background script
browser.runtime.onMessage.addListener(async (message, sender, sendResponse) => {
    const action = message.action;
    const data = message.data;
    if (logToConsole) console.log(message.action);
    if (message && message.type === "NEW_CONTEXT_READY") {
        if (logToConsole) console.log("Received NEW_CONTEXT_READY message. Starting re-synchronization.");
        await init();
    }
    switch (action) {
        case 'updateOptions':
            options = data.options;
            if (logToConsole) console.log('Options updated:', options);
            break;
        case 'updateSearchEngines':
            searchEngines = data.searchEngines;
            if (logToConsole) console.log('Search engines updated:', searchEngines);
            break;
        case 'launchIconsGrid':
            handleAltClickWithGrid(null);
            break;
        case 'getSearchEngine':
            getOpenSearchEngine().then((result) => {
                if (result) {
                    sendMessage('addNewSearchEngine', result);
                } else {
                    sendMessage('notify', notifySearchEngineNotFound);
                }
            }).catch((error) => {
                if (logToConsole) console.error(error);
                sendResponse({ success: false });
                return false;
            });
            return true;
        case 'getPosition':
            {
                const width = data.width;
                const height = data.height;
                const { left, top } = calculatePosition(width, height);
                sendResponse({ left, top });
                return true;
            }
        default:
            if (logToConsole) console.error("Unexpected action:", action);
            sendResponse({ success: false });
            return false;
    }
    sendResponse({ success: true });
    return true;
});

// Detect the underlying OS
async function getOS() {
    try {
        // Try modern userAgentData first (supported in modern browsers)
        if (navigator.userAgentData) {
            const platform = (await navigator.userAgentData.getHighEntropyValues(['platform'])).platform.toLowerCase();
            if (platform.includes('macos')) return 'macOS';
            if (platform.includes('windows')) return 'Windows';
            if (platform.includes('linux')) return 'Linux';
        }

        // Fallback to user agent if background script detection fails
        const ua = navigator.userAgent.toLowerCase();

        if (ua.includes('mac os x')) return 'macOS';
        if (ua.includes('windows')) return 'Windows';
        if (ua.includes('linux')) return 'Linux';
        if (ua.includes('android')) return 'Android';
        if (ua.includes('iphone') || ua.includes('ipad') || ua.includes('ipod')) return 'iOS';
        return 'Windows'; // Safe default
    } catch (error) {
        console.error('Error detecting OS:', error);
        return 'Windows';
    }
}

// Function that determines if the browser being used is Chromium-based (e.g. Chrome) or is Gecko-based (e.g. Firefox)
function getBrowserType() {
    const userAgent = navigator.userAgent.toLowerCase();
    return userAgent.includes("chrome") ? "chrome" : "firefox";
}

// Function that determines the meta key based on the OS
function initMetaKey() {
    if (os === 'macOS') {
        meta = 'Cmd';
    } else if (os === 'Windows') {
        meta = 'Win';
    } else if (os === 'Linux') {
        meta = 'Super';
    } else {
        meta = 'Meta';
    }
}

function calculatePosition(width, height) {
    const left = Math.round((screen.width - width) / 2);
    const top = Math.round((screen.height - height) / 2) - 200;
    return { left, top };
}

async function getOpenSearchEngine() {
    try {
        const url = document.querySelector('link[type="application/opensearchdescription+xml"]').href;
        if (logToConsole) console.log(url);
        // Fetch search engine data
        const result = await getNewSearchEngine(url);
        // Send msg to background script to get the new search engine added
        if (result) {
            return result;
        } else {
            return null;
        }
    } catch (err) {
        if (logToConsole) console.log(err);
        return null;
    }
}

async function ask(url, promptText) {
    if (logToConsole) console.log(`Prompt is: ${promptText}`);
    if (logToConsole) console.log(`URL is: ${url}`);
    if (logToConsole) console.log(`Ready state is: ${document.readyState}`);

    // Check if we're on the login page by looking for login-specific elements
    const loginButton = document.querySelector('button[data-testid="login-button"]');
    const loginForm = document.querySelector('form[data-testid="login-form"]');
    if (loginButton || loginForm) {
        if (logToConsole) console.log("Login page detected, cannot proceed.");
        return;
    }

    let submissionMade = false;

    // Wait for the main chat interface to load
    await new Promise(resolve => setTimeout(resolve, 1000));

    const handleChatInput = async () => {
        if (submissionMade) return; // Prevent multiple submissions

        const enterEvent = new KeyboardEvent('keydown', {
            bubbles: true,
            cancelable: true,
            key: 'Enter',
            code: 'Enter',
            keyCode: 13,
            which: 13
        });

        let textarea, submit;

        // Get the text area and submit button based on the AI chat engine
        if (url.includes('aistudio.google.com')) {
            if (logToConsole) console.log("AI Studio detected.");
            textarea = document.querySelector('textarea[placeholder="Type something"]');
            submit = document.querySelector("button[class*='run-button']");
        } else if (url.includes('www.perplexity.ai')) {
            textarea = document.querySelector('textarea[placeholder="Ask anything..."]');
            submit = document.querySelector('button[aria-label="Submit"]');
        } else if (url.includes('poe.com')) {
            textarea = document.querySelector('textarea[placeholder="Start a new chat"]');
            //submit = document.querySelector("button[class*='ChatMessageSendButton']");
            submit = false;
        } else if (url.includes('chatgpt.com')) {
            textarea = document.querySelector('[data-testid="text-area-input"]') ||
                document.querySelector('div.ProseMirror[contenteditable="true"]');
            submit = document.querySelector('button[data-testid="send-button"]') ||
                document.querySelector('button[aria-label="Send message"]');
        } else if (url.includes('claude.ai')) {
            textarea = document.querySelector('div[contenteditable="true"]');
        } else if (url.includes('you.com')) {
            textarea = document.getElementById('search-input-textarea');
            submit = document.querySelector('button[data-testid="qb_submit_button"]');
        } else if (url.includes('andisearch.com')) {
            textarea = document.querySelector('div[placeholder="Ask Andi..."]');
            submit = document.querySelector('button.rcw-send[type="submit"]');
        } else if (url.includes('grok.com')) {
            while (!textarea) {
                await new Promise(resolve => setTimeout(resolve, 500));
                textarea = document.querySelector('textarea[aria-label="Ask Grok anything"]');
            }
            submit = document.querySelector('button[aria-label="Submit"]');
        } else {
            const textareas = document.getElementsByTagName("textarea");
            textarea = textareas[textareas.length - 1];
            const buttons = document.getElementsByTagName("button");
            submit = buttons[buttons.length - 1];
        }

        if (logToConsole) console.log(`Text area:`);
        if (logToConsole) console.log(textarea);
        if (logToConsole) console.log(`Submit button:`);
        if (logToConsole) console.log(submit);

        if (textarea) {
            // Focus the textarea first
            textarea.focus();

            if (logToConsole) console.log("Text area found.");

            if (url.includes('claude.ai')) {
                textarea.textContent = promptText;
                await new Promise(resolve => setTimeout(resolve, 1000));
                submit = document.querySelector('button[aria-label="Send Message"]');
            } else {
                // Set text content
                if (textarea.tagName === 'DIV') {
                    // For contenteditable divs
                    textarea.textContent = promptText;
                    if (logToConsole) console.log(`Textarea (content): ${textarea.textContent}`);
                } else {
                    // For other input types
                    textarea.value = promptText;
                    if (logToConsole) console.log(`Textarea (value): ${textarea.value}`);
                }
            }

            // Dispatch input event to ensure React recognizes the change
            textarea.dispatchEvent(new Event('input', {
                bubbles: true,
                cancelable: true
            }));

            // Wait for React to process the input
            await new Promise(resolve => setTimeout(resolve, 500));

            textarea.dispatchEvent(enterEvent);

            // Wait to see if that worked
            await new Promise(resolve => setTimeout(resolve, 500));
        }

        if (submit && !submit.disabled) {
            let submissionSuccessful = false;
            try {
                submit.focus();
                submit.click();
                submissionSuccessful = textarea.textContent === '' || textarea.value === '' || submit.disabled;
                if (submissionSuccessful && logToConsole) console.log("Standard submission successful.");
            } catch (error) {
                if (logToConsole) console.log("Submission failed:", error);
            }

            // Fallback if the standard click() method didn't work
            if (!submissionSuccessful) {
                // Try with PointerEvent
                try {
                    const clickEvent = new PointerEvent('click', {
                        view: window,
                        bubbles: true,
                        cancelable: true,
                        pointerType: 'mouse',
                        isPrimary: true
                    });

                    submit.dispatchEvent(clickEvent);
                    submissionSuccessful = true;
                    if (logToConsole) console.log("Submission clicked with PointerEvent.");
                } catch (error) {
                    if (logToConsole) console.log("PointerEvent failed:", error);
                }
            }

            submissionMade = submissionSuccessful;

            if (!submissionSuccessful) {
                if (logToConsole) console.log("All submission attempts failed.");
            }
        } else {
            if (logToConsole) console.log("Submit button not found or disabled.");
        }
    };

    // Run the handler directly if the page is already loaded and doesn't need waiting for mutations
    if (document.readyState === 'complete' && !submissionMade && !window.location.href.includes('#_sidebar')) {
        if (logToConsole) console.log("Page is ready, handling it directly...");
        await handleChatInput();
    } else if (document.readyState === 'complete' && !submissionMade && window.location.href.includes('#_sidebar')) {
        // Wait for the page to load and then handle the input
        new MutationObserver(() => {
            if (logToConsole) console.log("Sidebar content script loaded, handling it...");
            handleChatInput();
            //browser.runtime.sendMessage({ action: "sidebarContentUpdated", url: window.location.href });
        }).observe(document.documentElement, { childList: true, subtree: true });
    }
}

async function init() {
    tabUrl = window.location.href;
    pn = window.location.pathname;
    domain = window.location.hostname;
    let postRequest = false;
    let trimmedUrl;

    // Get OS
    os = await getOS();

    // Initialize meta key depending on OS
    initMetaKey();

    if (tabUrl.endsWith('/')) {
        trimmedUrl = tabUrl.slice(0, -1);
    } else {
        trimmedUrl = tabUrl;
    }

    try {
        const response = await sendMessage('getStoredData', null);
        if (response.success) {
            const storedData = response.data;
            logToConsole = storedData.logToConsole;
            options = storedData.options;
            searchEngines = storedData.searchEngines;
            textSelection = storedData.selection;
        } else if (logToConsole) {
            console.log('No stored data found');
        }
    } catch (error) {
        if (logToConsole) console.warn('Failed to get stored data:', error);
    }

    // If debugging mode is enabled, log the tab url and domain
    if (logToConsole) {
        console.log(`OS: ${os}`);
        console.log(`Meta key: ${meta}`);
        console.log(`Tab url: ${tabUrl}`);
        console.log(`Path name: ${pn}`);
        console.log(`Domain: ${domain}`);
        console.log(`Text selection: ${textSelection}`);
        console.log('Options: ', options);
        console.log('Search engines: ', searchEngines);
    }

    // If the web page contains selected text, then send it to the background script
    const hasSelection = window.getSelection()?.rangeCount > 0;
    if (hasSelection) {
        await handleSelectionEnd();
    }

    if (tineyeUrl.startsWith(trimmedUrl)) {
        // Handle reverse image searches from Tineye
        const response = await sendMessage('getImageUrl', null);
        if (response.action === 'fillFormWithImageUrl' && response.data) {
            const { imageUrl } = response.data;
            const urlBox = document.getElementById('url_box');
            const submitButton = document.getElementById('url_submit');

            if (urlBox && submitButton) {
                if (logToConsole) console.log(`Tineye detected and image url is: ${imageUrl}`);
                // Set the value
                urlBox.value = imageUrl;

                // Trigger input event to ensure form validation
                urlBox.dispatchEvent(new Event('input', {
                    bubbles: true,
                    cancelable: true
                }));

                // Trigger change event
                urlBox.dispatchEvent(new Event('change', {
                    bubbles: true,
                    cancelable: true
                }));

                // Trigger click event on submit button
                submitButton.dispatchEvent(new MouseEvent('click', {
                    view: window,
                    bubbles: true,
                    cancelable: true
                }));

                // As a fallback, if the button is within a form
                const form = submitButton.closest('form');
                if (form) {
                    form.dispatchEvent(new Event('submit', {
                        bubbles: true,
                        cancelable: true
                    }));
                }
            }
        }
    } else if (trimmedUrl.startsWith(bingUrl)) {
        // Handle reverse image searches from Bing
        const response = await sendMessage('getImageUrl', null);
        if (response.action === 'fillFormWithImageUrl' && response.data) {
            const { imageUrl } = response.data;
            // Find the input element
            const inputField = document.getElementById('vsk_imgpst');
            inputField.focus();
            inputField.value = imageUrl;

            // Create an input event to trigger any listeners
            const event = new InputEvent('input', {
                bubbles: true,
                cancelable: true,
            });
            inputField.dispatchEvent(event);

            // Simulate Enter key press
            const enterEvent = new KeyboardEvent('keypress', {
                bubbles: true,
                cancelable: true,
                key: 'Enter',
                keyCode: 13,
                which: 13
            });
            inputField.dispatchEvent(enterEvent);
        }
    } else if (!googleReverseImageSearchUrl.startsWith(trimmedUrl) && !googleLensUrl.startsWith(trimmedUrl)) {
        // Identify the search engine corresponding to the domain and determine if it uses an HTTP POST request
        for (let id in searchEngines) {
            if (id.startsWith('separator-') || id.startsWith('link-') || id.startsWith('chatgpt-') || searchEngines[id].isFolder) continue;
            const url = searchEngines[id].url;
            const post = (searchEngines[id].formData) ? true : false;
            if (url.startsWith('https://' + domain) && post) {
                postRequest = true;
                break;
            }
        }
    }

    // If the web page is for an AI search or a HTTP POST request, then send a message to the background script and wait for a response
    if (aiUrls.includes(trimmedUrl) || postRequest) {
        if (logToConsole && !postRequest) console.log(`AI search engine detected: ${domain}`);
        const response = await sendMessage('contentScriptLoaded', { domain, tabUrl });
        if (response.action === 'askPrompt') {
            try {
                const { url, prompt } = response.data;
                await ask(url, prompt);
            } catch (err) {
                if (logToConsole) console.log(err);
                await sendMessage('notify', notifySearchEngineNotFound);
            }
        } else if (response.action === 'displaySearchResults') {
            try {
                const results = response.data;
                const html = document.getElementsByTagName('html')[0];
                const parser = new DOMParser();
                const doc = parser.parseFromString(results, 'text/html');
                if (logToConsole) console.log(results);
                if (logToConsole) console.log(doc.head);
                if (logToConsole) console.log(doc.body);
                html.removeChild(document.head);
                html.removeChild(document.body);
                html.appendChild(doc.head);
                html.appendChild(doc.body);
            } catch (err) {
                if (logToConsole) console.log(err);
                await sendMessage('notify', notifySearchEngineNotFound);
            }
        } else if (response && response.action === "noAction") {
            // No action needed, this is a valid response
            if (logToConsole) console.log('No action needed for this page');
        } else {
            if (logToConsole) console.error("Received undefined response or unexpected action from background script.");
            if (logToConsole) console.log('Response: ', response);
        }
    }

    // If the website doesn't contain an opensearch description, then hide the Page action
    // Check if the current page supports OpenSearch
    let hasOpenSearch = !!document.querySelector('link[type="application/opensearchdescription+xml"]');

    // If there exists a search engine with a query string that includes the domain of the visited web page, then hide the Page action
    for (let id in searchEngines) {
        if (id.startsWith("separator-") || id.startsWith("chatgpt-") || searchEngines[id].isFolder) continue;
        if (searchEngines[id].url.includes(domain)) {
            if (logToConsole) console.log('This web page has already been added to your list of search engines.');
            hasOpenSearch = false;
            break;
        }
    }

    // Notify the background script
    sendMessage("updateOpenSearchSupport", { supportsOpenSearch: hasOpenSearch });

    // Display clickable icons (buttons) for mycroftproject.com
    if (!hasContextSearchImage) showButtons();

    // For all input elements on the page that are descendants of a form element, except for input elements with the type "hidden" or without any type, add a double click event listener
    document.querySelectorAll('form input:not([type="hidden"])').forEach(inputTextField => {
        inputTextField.addEventListener('dblclick', handleInputDblclick);
    });
}

// Check if the current web page contains a 'Context Search' icon
function hasContextSearchImage() {
    // Get all img elements on the page
    const images = document.getElementsByTagName('img');

    // Convert the HTMLCollection to an array and use some() to check
    return Array.from(images).some(img =>
        img.src.includes('context-search.svg')
    );
}

// Handle double click event on input elements for websites that use HTTP POST method
async function handleInputDblclick(e) {
    if (logToConsole) console.log(e);
    const inputElement = e.target;
    if (logToConsole) console.log(e.target.tagName);
    if (logToConsole) console.log(textSelection);
    if (inputElement.tagName !== 'INPUT' || textSelection) return;
    const form = getClosestForm(inputElement);
    const action = form?.action;
    let url;
    if (logToConsole) console.log(action);
    if (action) {
        url = action;
    } else return;
    if (logToConsole) console.log(url);

    // Fetch all input elements within the form
    const inputs = form.querySelectorAll('input');
    let formData = {};

    // Loop through each input element to gather key-value pairs
    inputs.forEach(input => {
        if (logToConsole) console.log(input);
        const name = input.name;
        let value;
        if (input === inputElement) {
            value = '%s';
        } else {
            value = input.value;
        }

        // Check if the input has a name attribute and add to formData
        if (name) {
            formData[name] = value;
        }
    });

    // Open modal dialog to input new search engine data
    await openModal(url, formData);

}

// This function opens a new window with your modal form
async function openModal(url, formData) {
    await browser.runtime.sendMessage({
        action: 'openModal',
        data: { url: url, formData: formData }
    });
}

// Traverse up the DOM tree from the given element until a form element is found, or until the root of the document is reached. If a form element is found, return the form element, otherwise return null.
function getClosestForm(element) {
    while (element) {
        if (element.tagName === 'FORM') {
            return element;
        }
        element = element.parentElement;
    }
    return null;
}

// Check if there is a selection and handle it
async function checkForSelection(e) {
    const hasSelection = window.getSelection()?.rangeCount > 0;
    let element;
    if (e !== null) {
        element = e.target;
    } else if (hasSelection) {
        element = document.activeElement;
    } else {
        return;
    }

    if (logToConsole) console.log(element);
    if (logToConsole) console.log(hasSelection);

    if ((e === null ||
        (e !== null && (e.key === 'Shift' || (e.type === 'mouseup' && e.button === 0)))) &&
        (
            element.tagName === "TEXTAREA" ||
            (element.tagName === "INPUT" && element.type === "text")
        )
    ) {
        // If the active element is a textarea or input and the selection is not empty, handle selection end
        if (logToConsole) console.log('Active element is a textarea or input');
        if (element.selectionStart !== element.selectionEnd) {
            const selection = element.value.substring(element.selectionStart, element.selectionEnd);
            await handleSelectionEnd(selection);
        }
    } else if (hasSelection && !selectionActive && (e !== null && (e.ctrlKey || e.key === 'Shift' || (e.type === 'mouseup' && e.button === 0)))) {
        // On keyup, if the control key is released and there's a text selection, handle selection end
        await handleSelectionEnd();
    }
}

// Handle keyboard shortcuts
async function handleKeyUp(e) {
    if (logToConsole) console.log(e);

    const modifiers = ['Meta', 'Control', 'Shift', 'Alt'];

    await checkForSelection(e);

    // If no key has been pressed or if text is being typed in an INPUT field then discontinue
    if (!Object.keys(keysPressed).length > 0 || e.target.nodeName === 'INPUT' || !isKeyAllowed(e)) return;

    if (logToConsole) console.log(keysPressed);

    // Store all modifier keys pressesd in var input
    let input = "";
    for (let modifier of modifiers) {
        if (logToConsole) console.log(modifier);
        if (!(modifier in keysPressed)) continue;
        switch (modifier) {
            case 'Meta':
                input = input + meta + '+';
                break;
            case 'Control':
                input = input + 'Control+';
                break;
            case 'Shift':
                input = input + 'Shift+';
                break;
            case 'Alt':
                input = input + 'Alt+';
                break;
            default:
        }
        delete keysPressed[modifier];
    }
    if (logToConsole) console.log(`Modifier key(s) pressed: ${input}`);
    if (logToConsole) console.log(`Remaining key pressed: ${keysPressed}`);

    // If only modifier keys were pressed, then discontinue
    if (Object.keys(keysPressed).length === 0) {
        // Reset keys pressed
        keysPressed = {};
        return;
    }

    // If more than one non-modifier key was pressed, then only the first key is used
    const key = Object.keys(keysPressed)[0];

    if (os === 'macOS' && keysPressed[key]) {
        input += keysPressed[key].substring(3);
    } else if (key) {
        input += key;
    }

    if (logToConsole) console.log(`Keys pressed: ${input}`);

    // --- Add this check to ignore manifest commands ---
    const browserType = getBrowserType();
    let manifestCommandShortcuts = ["Alt+J", "Alt+K"]; // Define the shortcuts from the Chrome manifest
    if (browserType === 'firefox') {
        // Define the shortcuts from the Firefox manifest
        manifestCommandShortcuts = ["Control+Shift+J", "Control+Shift+K"];
    }
    // Use case-insensitive comparison, similar to how search engine shortcuts are checked
    if (manifestCommandShortcuts.some(cmd => cmd.toLowerCase() === input.toLowerCase())) {
        if (logToConsole) console.log(`Ignoring manifest command shortcut: ${input}`);
        keysPressed = {}; // Reset keys pressed state
        return; // Exit the function early, let the browser handle the command
    }
    // --- End check ---

    // Reset keys pressed
    keysPressed = {};

    // Check if the input text matches any search engine keyboard shortcut
    for (let id in searchEngines) {
        if (logToConsole) console.log(id);
        const keyboardShortcut = searchEngines[id].keyboardShortcut.toLowerCase().replace('ctrl', 'control');
        if (keyboardShortcut && keyboardShortcut === input.toLowerCase()) {
            if (logToConsole) console.log(`Matched keyboard shortcut: ${keyboardShortcut}`);
            await sendMessage('doSearch', { id: id });
            break;
        }
    }
}

// Use mouse down to store selected text
function startSelection(event) {
    if (event.button === 0) { // 0 indicates the left mouse button
        selectionActive = true;
    }
}

async function handleRightClickWithoutGrid(e) {
    if (logToConsole) console.log(e);
    const elementClicked = e.target;
    const tag = elementClicked.tagName;

    // If right click is on image then remove selection
    if (tag === 'IMG') {
        if (window.getSelection) {
            window.getSelection().removeAllRanges();
        }
    }
}

// Triggered by mouse up event
async function handleAltClickWithGrid(e) {
    if (logToConsole) console.log('Event triggered:', e);
    if (logToConsole) console.log('Options:', options);

    if (e !== null && e.button === 0) { // 0 indicates the left mouse button
        selectionActive = false;
    } else if (e !== null && e.button !== 0) {
        return;
    }

    if (!options || options.disableAltClick) return;

    await checkForSelection(e);
    if (!textSelection) return;

    // If the grid of icons is already displayed, then close the grid and empty the text selection
    const nav = document.getElementById('context-search-icon-grid');
    if (nav !== undefined && nav !== null) {
        closeGrid();
    }

    // IF the content script received the message to launch the Icons Grid (e === null)
    // OR the Quick Icons Grid is activated on mouse up (options.quickIconGrid)
    // OR the option (alt) key is pressed on mouse up (e.altKey)
    if (e === null || options.quickIconGrid || e.altKey) {
        // THEN display the Icons Grid
        let x, y;
        if (logToConsole) console.log('Displaying Icons Grid...');
        if (e !== null) {
            x = e.clientX;
            y = e.clientY;
        } else {
            ({ x, y } = getSelectionEndPosition());
        }
        xPos = x + parseInt(options.offsetX);
        yPos = y + parseInt(options.offsetY);
        if (logToConsole) console.log(xPos, yPos);
        if (xPos > 0 && yPos > 0) await createIconsGrid('root');
    }
}

function getSelectionEndPosition() {
    const sel = window.getSelection();
    if (sel.rangeCount > 0) {
        // Get the last range in the selection.
        const range = sel.getRangeAt(sel.rangeCount - 1);
        const rect = range.getBoundingClientRect();
        return { x: rect.left + rect.width, y: rect.top + rect.height };
    }
    return { x: 0, y: 0 };
}

async function handleMouseOver(e) {
    const elementOver = e.target;
    const tag = elementOver.tagName;

    // Traverse up the DOM tree to check if a parent has the ID 'context-search-icon-grid'
    let target = elementOver;
    let level = 0;
    while (target && level < 3) {
        if (target.id === 'context-search-icon-grid') {
            return; // Exit the function if a parent has the ID
        }
        target = target.parentElement;
        level++;
    }

    // If right click is on image or a div with class 'iris-annotation-layer' then send the target url
    if (tag === 'IMG' || (tag === 'DIV' && [...elementOver.classList].includes('iris-annotation-layer'))) {
        if (logToConsole) console.log(e);
        if (elementOver.parentId === 'context-search-icon-grid') return;
        if (domain.includes('youtube.com') || domain.includes('youtu.be') || domain.includes('youtube-nocookie.com') || domain.includes('vimeo.com')) {
            // Get the video url
            const videoUrl = absoluteUrl(getClosestAnchorHref(elementOver));
            //const videoId = new URL(videoUrl).searchParams.get('v');
            //const downloadUrl = ytDownloadUrl + videoId;
            await sendMessage('storeTargetUrl', videoUrl);
            if (logToConsole) console.log(`Video url: ${videoUrl}`);
        } else {
            // Get the image url
            const imgUrl = absoluteUrl(elementOver.getAttribute('src'));
            await sendMessage('storeTargetUrl', imgUrl);
            if (logToConsole) console.log(`Image url: ${imgUrl}`);
        }
    }
}

/* async function handleRightClickWithoutGrid(e) {
    if (logToConsole) console.log(e);

    const elementClicked = e.target;
    const tag = elementClicked.tagName;

    // If right click is NOT on image or a div with class 'iris-annotation-layer' then send the target url
    if (!(tag === 'IMG' || (tag === 'DIV' && [...elementClicked.classList].includes('iris-annotation-layer')))) {
        const selectedText = getSelectedText();
        if (logToConsole) console.log(selectedText);

        // Send the selected text to background.js
        try {
            // Send the selected text to background.js
            await sendMessage('setSelection', { selection: selectedText });
        } catch (error) {
            // Just log the error and continue - this is a non-critical operation
            if (logToConsole) console.warn('Failed to send selection:', error);
        }
    } else {
        if (window.getSelection) {
            window.getSelection().removeAllRanges();
        }
    }
} */

function getClosestAnchorHref(imgElement) {
    if (!imgElement || imgElement.tagName !== 'IMG') {
        throw new Error('Provided element is not an img tag');
    }

    const anchorElement = imgElement.closest('a');
    return anchorElement ? anchorElement.href : null;
}

// Display clickable buttons/icons on mycroftproject.com
async function showButtons() {
    if (domain !== 'mycroftproject.com') return;
    const installLinks = document.querySelectorAll('a[href^="/install.html"]');
    const links = Array.from(installLinks);
    if (logToConsole) console.log(links);

    links.forEach(link => {
        let img = new Image();
        img.src = browser.runtime.getURL('/icons/context-search.svg');
        img.className = 'icon';
        img.height = '16px';
        img.style.marginRight = '5px';
        img.style.cursor = 'pointer';
        img.title = browser.i18n.getMessage("AddSearchEngine");

        img.onclick = async function () {
            const href = link.getAttribute('href');
            const pid = getPidAndName(href).pid;
            const name = getPidAndName(href).name;
            const url = mycroftUrl + pid + '/' + name + '.xml';
            const result = await getNewSearchEngine(url);
            // Send msg to background script to get the new search engine added
            if (result !== null) {
                await sendMessage('addNewSearchEngine', result);
            }
        }

        link.parentNode.insertBefore(img, link);
    });
}

async function handleSelectionEnd(selection = '') {
    const controlCharactersRegex = /[\x00-\x1f\x7f-\x9f]/g;
    let plaintext = selection;

    if (plaintext === '') {
        // Get the Selection object
        const sel = window.getSelection();

        // Check if the Selection object has any ranges
        if (sel && !sel.isCollapsed) {
            const selectionCount = sel.rangeCount;
            if (selectionCount > 0) {
                for (let i = 0; i < selectionCount; i++) {
                    const range = sel.getRangeAt(i);
                    plaintext += range.toString();
                }
            }
        }
    }

    // Replace control characters with a space and escape single and double quotes
    plaintext = plaintext.replace(controlCharactersRegex, ' ').replace(/['"]+/g, "\\$&").trim();

    if (plaintext) {
        if (logToConsole) console.log(`Selected text: ${plaintext}`);

        // Store locally in memory regardless of storage success
        textSelection = plaintext;

        // Try to store data via the service worker (more reliable than direct storage)
        try {
            await sendMessage('storeSelection', plaintext);

            if (logToConsole) {
                console.log("Selection data successfully stored via service worker");
            }
        } catch (error) {
            // Fallback to direct storage if messaging fails
            console.warn("Error sending data to service worker", error);
        }
    }
}

function getPidAndName(string) {
    const queryString = string.substring(string.indexOf('?'));
    if (logToConsole) console.log(`query string: ${queryString}`);
    const urlParams = new URLSearchParams(queryString);
    const pid = urlParams.get('id');
    const name = urlParams.get('name');
    return { pid: pid, name: name };
}

async function createIconsGrid(folderId) {
    let icons = [];

    // If the parent folder is not the root folder, then add an icon for backwards navigation
    if (folderId !== 'root') {
        icons.push({
            id: 'back',
            src: 'data:image/png;base64,' + base64BackIcon,
            title: 'back',
        });
    }

    // Only include the multi-search icon in the Icons Grid if required
    for (const id in searchEngines) {
        if (searchEngines[id].isFolder) continue;
        if (folderId === 'root' && searchEngines[id].multitab) {
            icons.push({
                id: 'multisearch',
                src: 'data:image/svg+xml;base64,' + base64MultiSearchIcon,
                title: 'multi-search',
            });
            break;
        }
    }

    // Add an icon for each search engine and folder
    for (const id of searchEngines[folderId].children) {
        const searchEngine = searchEngines[id];
        if (!id.startsWith("separator-") && searchEngine && (searchEngine.show || searchEngine.isFolder)) {
            const imageFormat = searchEngine.imageFormat || 'image/png';
            const title = searchEngine.name;
            let src = `data:${imageFormat};base64,`;
            if (isEmpty(searchEngine) || isEmpty(searchEngine.base64)) {
                // Default icon when no favicon could be found
                src += base64ContextSearchIcon;
            } else {
                const base64String = searchEngine.base64;
                src += base64String;
            }
            icons.push({ id: id, src: src, title: title });
        }
    }

    // Grid dimensions
    const n = icons.length;
    const m = Math.ceil(Math.sqrt(n)); // Grid dimension: m x m matrix
    const navMaxWidth = m * 38 + 16;

    // Cleanup
    closeGrid();

    const nav = document.createElement('div');
    nav.setAttribute('id', 'context-search-icon-grid');
    nav.style.maxWidth = navMaxWidth + 'px';
    nav.style.transition = 'none';
    nav.style.backgroundColor = '#ccc';
    nav.style.border = '3px solid #999';
    nav.style.padding = '5px';
    nav.style.borderRadius = '20px';
    nav.style.zIndex = 9999;
    nav.style.position = 'fixed';
    nav.style.setProperty('top', yPos.toString() + 'px');
    nav.style.setProperty('left', xPos.toString() + 'px');
    nav.style.gridTemplateColumns = `repeat(${m}, 1fr)`;
    nav.style.display = 'grid';
    nav.style.gap = '4px';


    for (const icon of icons) {
        if (logToConsole) console.log(icon);
        const iconElement = document.createElement("img");
        iconElement.style.width = ICON32;
        iconElement.style.height = ICON32;
        iconElement.style.display = 'inline-block !important';
        iconElement.style.border = '3px solid #ccc';
        iconElement.style.borderRadius = '10px';
        iconElement.setAttribute('id', icon.id);
        iconElement.setAttribute('src', icon.src);
        iconElement.setAttribute('title', icon.title);
        iconElement.addEventListener('mouseover', addBorder);
        iconElement.addEventListener('mouseleave', removeBorder);
        nav.appendChild(iconElement);
    }

    const body = document.getElementsByTagName('body')[0];
    body.appendChild(nav);

    // Define event listeners for the icon grid
    nav.addEventListener('mouseup', e => onGridClick(e, folderId));
    nav.addEventListener('mouseenter', onHover);
    nav.addEventListener('mouseleave', onLeave);

    // Position icon grid contained in nav element
    nav.style.left = 0;
    nav.style.top = 0;
    let viewportWidth = document.documentElement.clientWidth;
    let viewportHeight = window.innerHeight;
    let navWidth = nav.offsetWidth + 16;
    let navHeight = nav.offsetHeight;
    if (xPos > viewportWidth - navWidth) {
        nav.style.left = viewportWidth - navWidth + 'px';
    } else {
        nav.style.left = xPos + 'px';
    }
    if (yPos > viewportHeight - navHeight) {
        nav.style.top = viewportHeight - navHeight + 'px';
    } else {
        nav.style.top = yPos + 'px';
    }
}

async function onGridClick(e, folderId) {
    e.preventDefault();
    e.stopPropagation();
    if (!navEntered) return;
    if (logToConsole) console.log('Icons Grid got clicked:' + e.type);
    const id = e.target.id;
    if (logToConsole) console.log('Search engine clicked:' + id);
    closeGrid();

    if (id === 'back') {
        const parentId = getParentFolderOf(folderId, 'root');
        if (logToConsole) console.log('Parent folder of ' + folderId + ' is ' + parentId);
        await createIconsGrid(parentId);
        return;
    }

    if (id === 'multisearch' || !searchEngines[id].isFolder) {
        await sendMessage('doSearch', { id: id });
    } else {
        await createIconsGrid(id);
    }
}

function getParentFolderOf(folderId, startFolder) {
    for (const id of searchEngines[startFolder].children) {
        if (id === folderId) {
            return startFolder;
        } else if (searchEngines[id].isFolder) {
            const result = getParentFolderOf(folderId, id);
            if (result) {
                return result;
            }
        }
    }
    return null;
}

function onHover() {
    navEntered = true;
}

async function onLeave() {
    if (!options.closeGridOnMouseOut) return;
    if (logToConsole) console.log('Closing Icons Grid...');
    closeGrid();
}

function closeGrid() {
    let nav = document.getElementById('context-search-icon-grid');
    if (nav) {
        nav.parentElement.removeChild(nav);
        nav.removeEventListener('mouseup', onGridClick);
        nav.removeEventListener('mouseenter', onHover);
        nav.removeEventListener('mouseleave', onLeave);
        nav = null;
        navEntered = false;
    }
}

function addBorder(e) {
    if (logToConsole) console.log(e);
    if (logToConsole) console.log(e.target.tagName);
    if (e.target.tagName === 'IMG') {
        e.target.style.border = '3px solid #999';
    }
}

function removeBorder(e) {
    if (logToConsole) console.log(e);
    if (logToConsole) console.log(e.target.tagName);
    if (e.target.tagName === 'IMG') {
        e.target.style.border = '3px solid #ccc';
    }
}

/// Encode a url
function encodeUrl(url) {
    if (isEncoded(url)) {
        return url;
    }
    return encodeURIComponent(url);
}

/// Verify is uri is encoded
function isEncoded(uri) {
    uri = uri || '';
    return uri !== decodeURIComponent(uri);
}

async function sendMessage(action, data) {
    try {
        // Check if browser/chrome API is available
        if (!browser.runtime?.sendMessage) {
            throw new Error('Browser API not available');
        }
        if (logToConsole) console.log(`Sending message: action=${action}, data=${JSON.stringify(data)}`);
        const response = await browser.runtime.sendMessage({ action: action, data: data });
        if (logToConsole) console.log(`Received response: ${JSON.stringify(response)}`);
        return response;  // Return the response received from the background script
    } catch (error) {
        if (logToConsole) {
            if (!(error && error.message && error.message.includes("Extension context invalidated"))) {
                console.error(`Error sending message: ${error}`);
            }
        }
        return { success: false };
    }
}

function absoluteUrl(url) {
    // Create an anchor element (it automatically resolves relative URLs)
    const anchor = document.createElement('a');

    // Set the provided URL as the href of the anchor
    anchor.href = url;

    // The browser will automatically resolve it to the absolute URL
    return anchor.href;
}

async function getNewSearchEngine(url) {
    const xml = await fetchXML(url);
    const { shortName, queryString } = getNameAndQueryString(xml);

    // Prevent duplicates
    for (let id in searchEngines) {
        if (queryString === searchEngines[id].url) return null;
    }

    let id = shortName.replace(/\s/g, '-').toLowerCase();
    while (!isIdUnique(id)) {
        id = defineNewId(shortName);
    }
    id = id.trim();
    if (logToConsole) {
        console.log(id);
        console.log(shortName);
        console.log(queryString);
    }
    const numberOfSearchEngines = Object.keys(searchEngines).length;

    // Define new search engine to be added along with its default values
    searchEngines[id] = {
        index: numberOfSearchEngines,
        name: shortName,
        keyword: '',
        keyboardShortcut: '',
        multitab: false,
        url: queryString,
        show: true,
        base64: '',
    };

    if (logToConsole) console.log(searchEngines[id]);
    return { id: id, searchEngine: searchEngines[id] };
}

function fetchXML(url) {
    return new Promise((resolve, reject) => {
        let reqHeader = new Headers();
        reqHeader.append('Content-Type', 'text/xml');

        let initObject = {
            method: 'GET',
            headers: reqHeader
        };

        let userRequest = new Request(url, initObject);

        fetch(userRequest)
            .then((response) => response.text())
            .then((str) => new window.DOMParser().parseFromString(str, 'text/xml'))
            .then((xml) => {
                if (logToConsole) console.log(xml);
                resolve(xml);
            })
            .catch((err) => {
                if (logToConsole) console.log('Something went wrong!', err);
                reject(err);
            });
    });
}

// Retrieve the short name and query string from an xml document with the open search specifications
function getNameAndQueryString(xml) {
    let shortName, url;
    const x = xml.documentElement.childNodes;
    if (logToConsole) console.log(x);
    for (let node of x) {
        const key = node.nodeName;
        if (key === 'ShortName') shortName = node.textContent;
        if (key === 'Url') {
            let type = node.getAttribute('type');
            if (type === 'text/html') url = node.getAttribute('template');
        }
    }
    return { shortName: shortName, queryString: url };
}

// Define a random ID for the new search engine
function defineNewId(shortName) {
    let newId = shortName.replace(/\s/g, '-').toLowerCase();
    let randomNumber = Math.floor(Math.random() * 1000000);
    newId = newId + '-' + randomNumber.toString();
    if (logToConsole) console.log(newId);
    return newId;
}

// Ensure the ID generated is unique
function isIdUnique(testId) {
    for (let id in searchEngines) {
        if (id === testId) {
            return false;
        }
    }
    return true;
}

// Test if an object is empty
function isEmpty(value) {
    if (typeof value === 'number') return false;
    else if (typeof value === 'string') return value.trim().length === 0;
    else if (Array.isArray(value)) return value.length === 0;
    else if (typeof value === 'object') {
        return value === null || Object.keys(value).length === 0;
    } else if (typeof value === 'boolean') return false;
    else return !value;
}

function isKeyAllowed(event) {
    const disallowedKeys = [
        'Tab', 'Enter', 'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight',
        'Escape', ' ', 'Delete', 'Backspace', 'Home', 'End',
        'F1', 'F2', 'F3', 'F4', 'F5', 'F6', 'F7', 'F8', 'F9', 'F10', 'F11', 'F12',
    ];

    return !disallowedKeys.includes(event.key);
}